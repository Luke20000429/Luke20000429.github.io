---
layout: single
title:  "Profile VLLM Performance"
date:   2024-03-25
author_profile: true
comments: true
tags: [CUDA, UVM, Profiler]
---

This post is to log my profile of VLLM with UVM.

vllm

| block | seq_len | uvm      | normal   |     |
| ----- | ------- | -------- | -------- | --- |
| 1     | 4096    | 1028.550 | 1028.238 |     |
| 2     | 4096    | 1477.255 | 1476.911 |     |
| 4     | 4096    | 1464.686 | 1464.294 |     |
| 8     | 4096    | 238.968  | 239.627  |     |
| 16    | 4096    | 163.439  | 163.369  |     |
| 32    | 4096    | 289.493  | 289.022  |     |

Without page table lookup

| block | seq_len | batch-> | b1 time [us] | 1024    |
| ----- | ------- | ------- | ------------ | ------- |
| 1     | 4096    |         | 816.158      | 207.329 |
| 2     | 4096    |         | 1297.227     |         |
| 4     | 4096    |         | 1043.477     |         |
| 8     | 4096    |         | 217.600      | 64.420  |
| 16    | 4096    |         | 145.849      |         |
| 32    | 4096    |         | 326.260      |         |

Original vllm

| block | seq_len | batch-> | b1 time [us] |        |
| ----- | ------- | ------- | ------------ | ------ |
| 1     | 4096    |         | 1037.732     |        |
| 2     | 4096    |         | 1489.282     |        |
| 4     | 4096    |         | 1468.762     |        |
| 8     | 4096    |         | 251.441      | 68.620 |
| 16    | 4096    |         | 173.120      |        |
| 32    | 4096    |         | 298.460      |        |

Without page table lookup

| block | seq_len | batch-> | b32 time [us] | b16 time [us] |
| ----- | ------- | ------- | ------------- | ------------- |
| 1     | 1024    |         | 777.439       | 396.988       |
| 2     | 1024    |         | 731.292       | 368.940       |
| 4     | 1024    |         | 884.846       | 538.912       |
| 8     | 1024    |         | 990.562       | 611.939       |
| 16    | 1024    |         | 638.619       | 354.824       |
| 32    | 1024    |         | 633.239       | 362.255       |

Original vllm

| block | seq_len | batch-> | b32 time [us] | b16 time [us] |
| ----- | ------- | ------- | ------------- | ------------- |
| 1     | 1024    |         |               | 461.034       |
| 2     | 1024    |         |               | 856.398       |
| 4     | 1024    |         |               | 879.262       |
| 8     | 1024    |         |               | 332.499       |
| 16    | 1024    |         |               | 321.019       |
| 32    | 1024    |         |               | 340.325       |

No offset

| block | seq_len | batch-> | b32 time [us] | b16 time [us] |
| ----- | ------- | ------- | ------------- | ------------- |
| 1     | 1024    |         |               | 264.341       |
| 2     | 1024    |         |               | 620.199       |
| 4     | 1024    |         |               | 505.776       |
| 8     | 1024    |         |               | 176.526       |
| 16    | 1024    |         |               | 137.137       |
| 32    | 1024    |         |               | 184.604       |
